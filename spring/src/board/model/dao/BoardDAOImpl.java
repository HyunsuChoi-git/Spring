package board.model.dao;

import java.util.HashMap;
import java.util.List;

import org.apache.ibatis.session.SqlSession;
import org.mybatis.spring.SqlSessionTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;

import board.model.vo.BoardVO;
@Controller
public class BoardDAOImpl implements BoardDAO{
	
	private SqlSessionTemplate sqlSession = null;

	public SqlSessionTemplate getSqlSession() {
		return sqlSession;
	}

	public void setSqlSession(SqlSessionTemplate sqlSession) {
		this.sqlSession = sqlSession;
	}

	@Override
	public BoardVO insertArticle(BoardVO vo) throws Exception {
		
		int num = 0, ref = 0, re_step = 0, re_level = 0;
		if(vo.getNum() == 0) {  //새글 일 때
			//max num값 불러와서 ref에 담기
			int maxNum = 0;
			if(sqlSession.selectOne("numMax") != null) {
				maxNum = (Integer)sqlSession.selectOne("numMax");
			}
			ref = maxNum+1;
			
			re_step = 0;
			re_level = 0;
			
		}else if(vo.getNum() != 0){ //답글일 때 
			num = vo.getNum();
			ref = vo.getRef();
			sqlSession.selectOne("updateRe", ref);
			
			re_step = vo.getRe_step() +1;
			re_level = vo.getRe_level() +1;
		}
		
		vo.setNum(num);
		vo.setRef(ref);
		vo.setRe_step(re_step);
		vo.setRe_level(re_level);
		
		sqlSession.insert("insert", vo);
		
		
		return vo;
	}

	public int getArticleNum(BoardVO vo) throws Exception{
		int num = (Integer)sqlSession.selectOne("articleNum", vo);
		
		return num;
	}
	@Override
	public int getArticleCount() throws Exception {
		int count = (Integer)sqlSession.selectOne("board.countAll");
		
		return count;
	}

	@Override
	public List getArticles(int start, int end) throws Exception {
		HashMap map = new HashMap();
		
		map.put("start", start);
		map.put("end", end);
		
		List articles = sqlSession.selectList("getArticles", map);
		
		return articles;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
	}

	@Override
	public BoardVO getArticle(int num) throws Exception {
		
		sqlSession.selectOne("readCount", num);
		BoardVO vo = (BoardVO)sqlSession.selectOne("getArticle", num);
		return vo;
	}
	public BoardVO getArticle(int ref, int re_step, int re_level) throws Exception {
		return null;
	}


	@Override
	public BoardVO getArticleForUpdate(int num) throws Exception {
		
		BoardVO vo = (BoardVO)sqlSession.selectOne("getArticle", num);

		return vo;
	}

	@Override
	public int updateArticle(BoardVO vo) throws Exception {
		int check = 0;
		check = sqlSession.update("updateArticle", vo);
		
		return check;
	}

	@Override
	public int deleteArticle(int num, String passwd) throws Exception {
		// TODO Auto-generated method stub
		return 0;
	}
	public int deleteArticle(int num) throws Exception {
		int check = 0;
		
		check = sqlSession.delete("deleteArticle", num);
		
		return check;
	}
}
